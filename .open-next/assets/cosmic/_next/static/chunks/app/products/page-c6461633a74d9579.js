(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[571],{978:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>b});var r=t(5155),a=t(2115),n=t(2108),i=t(5695),l=t(1109),c=t(6715),o=t(5041);function d(e){let{status:s,showText:t=!0}=e,{badgeClass:a,text:n,icon:i}=(()=>{switch(s){case"synced":return{badgeClass:"badge-success",text:"Synced",icon:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"inline-block w-4 h-4 stroke-current",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})};case"error":return{badgeClass:"badge-error",text:"Error",icon:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"inline-block w-4 h-4 stroke-current",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})};case"syncing":return{badgeClass:"badge-warning",text:"Syncing",icon:(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"inline-block w-4 h-4 stroke-current animate-spin",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})};default:return{badgeClass:"badge-outline",text:"Not Synced",icon:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"inline-block w-4 h-4 stroke-current",children:(0,r.jsx)("circle",{cx:"12",cy:"12",r:"10",strokeWidth:"2"})})}}})();return(0,r.jsxs)("div",{className:"badge ".concat(a," gap-1"),children:[i,t&&(0,r.jsx)("span",{children:n})]})}var h=t(6766);let u=async e=>{let{productId:s,settings:t}=e;if(!t.siteId)throw Error("No Webflow site selected");try{let e;console.log("Syncing product ".concat(s," to Webflow site ").concat(t.siteId,"..."),{settings:t});let r=await fetch("/api/auth/session"),a=await r.json();if(!a||!a.user)throw console.error("Not authenticated - session check failed",a),Error("You need to be logged in to sync products");console.log("Session check passed, proceeding with sync");let n=await fetch("/api/webflow/sync",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({productId:s,siteId:t.siteId,autoDraft:t.syncOptions.autoDraft,includeImages:t.syncOptions.includeImages,skipExisting:t.syncOptions.skipExisting})});console.log("Sync API response:",{status:n.status,statusText:n.statusText,headers:Object.fromEntries([...n.headers.entries()])});let i=await n.text();console.log("Raw response:",i);try{e=JSON.parse(i)}catch(e){throw console.error("Failed to parse response as JSON:",e),Error(i||"Unknown server error")}if(!n.ok)throw Error(e.error||"Server error: ".concat(n.statusText));return e}catch(e){throw console.error("Error in sync process:",e),e}},x=e=>{let{variant:s}=e;return(0,r.jsxs)("tr",{className:"hover",children:[(0,r.jsx)("td",{className:"px-6 py-3 whitespace-nowrap"}),(0,r.jsxs)("td",{className:"px-6 py-3 whitespace-nowrap flex items-center gap-2",children:[s.preview_url&&(0,r.jsx)("div",{className:"avatar",children:(0,r.jsx)("div",{className:"mask mask-squircle w-8 h-8 relative",children:(0,r.jsx)(h.default,{src:s.preview_url,alt:s.name,fill:!0,sizes:"32px",style:{objectFit:"cover"}})})}),(0,r.jsx)("div",{className:"text-sm",children:s.name})]}),(0,r.jsx)("td",{className:"px-6 py-3 whitespace-nowrap",children:(0,r.jsx)("div",{className:"text-sm opacity-70",children:s.variant_id})}),(0,r.jsx)("td",{className:"px-6 py-3 whitespace-nowrap",children:(0,r.jsxs)("div",{className:"text-sm",children:["$",s.retail_price]})}),(0,r.jsx)("td",{className:"px-6 py-3 whitespace-nowrap",children:(0,r.jsx)(d,{status:s.sync_status||"not_synced"})}),(0,r.jsx)("td",{className:"px-6 py-3 whitespace-nowrap",children:(0,r.jsx)("div",{className:"text-sm",children:s.lastSynced?new Date(s.lastSynced).toLocaleString():"Never synced"})})]})},m=e=>{let{product:s,onSyncAll:t,isSyncing:a,syncingProductId:n,selectedSiteId:i}=e;return(0,r.jsx)("tr",{className:"bg-base-200",children:(0,r.jsx)("td",{colSpan:6,className:"px-6 py-3",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[s.thumbnail_url?(0,r.jsx)("div",{className:"avatar",children:(0,r.jsx)("div",{className:"mask mask-squircle w-8 h-8 relative",children:(0,r.jsx)(h.default,{src:s.thumbnail_url,alt:s.name,fill:!0,sizes:"32px",style:{objectFit:"cover"}})})}):(0,r.jsx)("div",{className:"avatar placeholder",children:(0,r.jsx)("div",{className:"bg-neutral-focus text-neutral-content mask mask-squircle w-8 h-8",children:(0,r.jsx)("span",{children:"N/A"})})}),(0,r.jsx)("span",{className:"font-medium",children:s.name}),(0,r.jsxs)("span",{className:"text-xs opacity-70",children:["(",s.filteredVariants.length," variants)"]})]}),(0,r.jsx)("button",{onClick:()=>t(),className:"px-4 py-1.5 bg-primary text-primary-content rounded-md text-sm font-medium hover:bg-primary-dark hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 active:shadow-none focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0  disabled:hover:shadow-none disabled:hover:bg-primary flex items-center gap-2",disabled:a||!i,title:i?"Sync this product and all variants":"Select a Webflow site first",children:a&&s.id===n?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"w-4 h-4 border-2 border-primary-content/30 border-t-primary-content rounded-full animate-spin"}),(0,r.jsx)("span",{children:"Syncing..."})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),(0,r.jsx)("span",{children:"Sync All"})]})})]})})})},p=e=>{if(!e)return"not_synced";let s=new Date,t=new Date(e),r=Math.floor((s.getTime()-t.getTime())/864e5);return r<=10?"synced":r<=30?"warning":"stale"},y=e=>{let{products:s,searchQuery:t,statusFilter:n,selectedSiteId:i,webflowSettings:l,isLoading:d}=e,h=(0,c.jE)(),{mutate:y,isPending:j,variables:f}=(0,o.n)({mutationFn:u,onSuccess:(e,s)=>{h.setQueriesData({queryKey:["products"]},t=>Array.isArray(t)?t.map(t=>t.id===s.productId?{...t,variants:t.variants.map(s=>({...s,lastSynced:e.lastSynced||new Date().toISOString(),sync_status:"success"===e.status?"synced":"not_synced"}))}:t):t)},onError:e=>{console.error("Sync failed:",e.message)}}),w=async e=>{if(!i){alert("Please select a Webflow site first");return}try{await y({productId:e,settings:l})}catch(e){console.error("Error in handleSyncProduct:",e)}},g=a.useMemo(()=>(console.log("Products received:",s),Array.isArray(s))?s.filter(e=>{if(!e||!e.variants)return console.log("Skipping product without variants:",e),!1;if(!Array.isArray(e.variants))return console.log("Product variants is not an array:",e),!1;if(0===e.variants.length)return!1;let s=e.name.toLowerCase().includes(t.toLowerCase())||e.variants.some(e=>{var s;return(null===(s=e.name)||void 0===s?void 0:s.toLowerCase().includes(t.toLowerCase()))||e.sku&&e.sku.toLowerCase().includes(t.toLowerCase())});if("all"===n)return s;let r=e.variants.some(e=>"synced"===e.sync_status),a=e.variants.some(e=>"not_synced"===e.sync_status||!e.sync_status);return("synced"===n&&!!r||"not_synced"===n&&!!a)&&s}).map(e=>{let s=Array.isArray(e.variants)?e.variants:[];return{...e,filteredVariants:s.map(s=>{let t=s.lastSynced||void 0;return{...s,id:s.id||"".concat(e.id,"-").concat(Math.random().toString(36).substring(2,11)),product_id:s.product_id||e.id,variant_id:s.variant_id||s.id||"variant-".concat(Math.random().toString(36).substring(2,11)),retail_price:s.retail_price||(s.price?s.price.toString():"0.00"),name:s.name||"Unnamed Variant",lastSynced:t,sync_status:p(t)}})}}):(console.error("Products is not an array:",s),[]),[s,t,n]),b=a.useMemo(()=>g.reduce((e,s)=>e+s.filteredVariants.length,0),[g]);return(a.useEffect(()=>{h.setDefaultOptions({queries:{staleTime:3e5,gcTime:18e5}})},[h]),d)?(0,r.jsx)("div",{className:"text-center py-8",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Loading products..."})}):0===g.length?(0,r.jsx)("div",{className:"text-center py-8",children:(0,r.jsx)("p",{className:"text-gray-500",children:"No products found matching your filters."})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"mb-4 text-sm opacity-70",children:["Showing ",b," variants across ",g.length," ","products"]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"Product"}),(0,r.jsx)("th",{children:"Variant"}),(0,r.jsx)("th",{children:"Variant ID"}),(0,r.jsx)("th",{children:"Price"}),(0,r.jsx)("th",{children:"Sync Status"}),(0,r.jsx)("th",{children:"Last Synced"})]})}),(0,r.jsx)("tbody",{children:g.map(e=>(0,r.jsxs)(a.Fragment,{children:[(0,r.jsx)(m,{product:e,onSyncAll:()=>w(e.id),isSyncing:j,syncingProductId:(null==f?void 0:f.productId)||null,selectedSiteId:i}),e.filteredVariants.map(e=>(0,r.jsx)(x,{variant:e},e.id))]},e.id))})]})})]})},j=e=>{let{searchQuery:s,statusFilter:t,onSearchChange:a,onStatusFilterChange:n}=e;return(0,r.jsxs)("div",{className:"mb-4 flex flex-col sm:flex-row justify-between gap-4",children:[(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"label text-xs",children:"Status"}),(0,r.jsxs)("div",{className:"btn-group space-x-1",children:[(0,r.jsx)("button",{className:"btn btn-xs ".concat("all"===t?"btn-primary":"btn-outline"),onClick:()=>n("all"),children:"All"}),(0,r.jsx)("button",{className:"btn btn-xs ".concat("synced"===t?"btn-primary":"btn-outline"),onClick:()=>n("synced"),children:"Synced"}),(0,r.jsx)("button",{className:"btn btn-xs ".concat("not_synced"===t?"btn-primary":"btn-outline"),onClick:()=>n("not_synced"),children:"Not Synced"}),(0,r.jsx)("button",{className:"btn btn-xs ".concat("error"===t?"btn-primary":"btn-outline"),onClick:()=>n("error"),children:"Error"})]})]})}),(0,r.jsxs)("div",{className:"form-control w-full sm:w-auto",children:[(0,r.jsx)("label",{className:"label",children:(0,r.jsx)("span",{className:"label-text text-xs",children:"Search"})}),(0,r.jsx)("input",{type:"text",value:s,onChange:e=>a(e.target.value),placeholder:"Search by name or ID...",className:"input input-bordered input-sm w-full"})]})]})};var f=t(9373),w=t(2118);let g=async e=>{try{let s=await fetch("/api/printful/store/products?siteId=".concat(e));if(!s.ok)throw console.error("Error fetching products:",s.status,s.statusText),Error("Failed to fetch products: ".concat(s.statusText));return(await s.json()).result||[]}catch(e){return console.error("Error fetching products:",e),[]}};function b(){let{data:e}=(0,n.useSession)(),s=(0,i.useRouter)(),{settings:t,updateSettings:c}=(0,w.z)(),[o,d]=(0,a.useState)(""),[h,u]=(0,a.useState)("all");(0,a.useEffect)(()=>{if(!e||e&&!e.isMultiConnected){s.push("/");return}},[e,s]);let{data:x=[],isLoading:m,error:p}=(0,f.I)({queryKey:["products",t.siteId],queryFn:()=>g(t.siteId),enabled:!!t.siteId&&!!e,staleTime:3e5});return(0,r.jsx)("div",{className:"flex min-h-screen flex-col",children:(0,r.jsx)("main",{className:"flex-1 p-8",children:(0,r.jsxs)("div",{className:"max-w-6xl mx-auto",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Printful Product Variants"}),(0,r.jsx)("div",{className:"mb-6",children:(0,r.jsx)(l.A,{onSettingsChange:c,initialSettings:t})}),!t.siteId||m||p?t.siteId?null:(0,r.jsx)("div",{className:"alert alert-info",children:(0,r.jsx)("span",{children:"Please select a Webflow site to view and sync products."})}):(0,r.jsxs)("div",{children:[(0,r.jsx)(j,{searchQuery:o,statusFilter:h,onSearchChange:d,onStatusFilterChange:u}),(0,r.jsx)(y,{products:x,searchQuery:o,statusFilter:h,selectedSiteId:t.siteId,webflowSettings:t,isLoading:m})]}),m&&(0,r.jsxs)("div",{className:"flex justify-center items-center p-8",children:[(0,r.jsx)("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"}),(0,r.jsx)("span",{className:"ml-2",children:"Loading products..."})]}),p&&(0,r.jsx)("div",{className:"alert alert-error",children:(0,r.jsxs)("span",{children:["Error loading products:"," ",p instanceof Error?p.message:"Unknown error"]})})]})})})}},1109:(e,s,t)=>{"use strict";t.d(s,{A:()=>m});var r=t(5155),a=t(2108),n=t(6715),i=t(9373),l=t(2115),c=t(5111),o=t.n(c);let d=o().basePath;function h(e){let{selectedSiteId:s,onSiteSelect:t}=e,[a,n]=(0,l.useState)([]),[i,c]=(0,l.useState)(!0),[o,h]=(0,l.useState)(null);return((0,l.useEffect)(()=>{(async function(){try{var e;c(!0),h(null);let r=await fetch("".concat(d,"/api/webflow/sites"));if(!r.ok)throw Error("Failed to fetch sites: ".concat(r.status," ").concat(r.statusText));let a=await r.json();n(a.sites||[]),(null===(e=a.sites)||void 0===e?void 0:e.length)!==1||s||t(a.sites[0].id)}catch(e){console.error("Error fetching Webflow sites:",e),h(e instanceof Error?e.message:String(e))}finally{c(!1)}})()},[t,s]),i)?(0,r.jsxs)("div",{className:"alert alert-info",children:[(0,r.jsx)("span",{className:"loading loading-spinner loading-sm"}),(0,r.jsx)("span",{children:"Loading Webflow sites..."})]}):o?(0,r.jsxs)("div",{className:"alert alert-error",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,r.jsxs)("span",{children:["Error: ",o]})]}):0===a.length?(0,r.jsxs)("div",{className:"alert alert-warning",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,r.jsx)("span",{children:"No Webflow sites found. Please create a site in Webflow first."})]}):(0,r.jsxs)("div",{className:"form-control mb-4",children:[(0,r.jsx)("label",{className:"label",htmlFor:"webflow-site-selector",children:(0,r.jsx)("span",{className:"label-text",children:"Select Webflow Site"})}),(0,r.jsxs)("select",{id:"webflow-site-selector",className:"select select-bordered bg-base-300 w-full focus:outline-primary text-base-content",value:s||"",onChange:e=>{let s=e.target.value;s&&t(s)},children:[(0,r.jsx)("option",{value:"",disabled:!0,children:a.length>1?"Select a Webflow site":"Select site"}),a.map(e=>(0,r.jsx)("option",{value:e.id,className:"text-base-content",children:e.displayName||e.shortName},e.id))]})]})}var u=t(2118);let x=o().basePath;function m(e){let{onSettingsChange:s}=e,{data:t}=(0,a.useSession)(),{settings:l,updateSettings:c}=(0,u.z)(),o=(0,n.jE)(),{data:d,isLoading:m}=(0,i.I)({queryKey:["webflow-sites"],queryFn:async()=>{let e=await fetch("".concat(x,"/api/webflow/sites"));if(!e.ok)throw Error("Failed to fetch sites");return e.json()},enabled:!!(null==t?void 0:t.webflowAccessToken)}),p=e=>{let t={...l,syncOptions:{...l.syncOptions,[e]:!l.syncOptions[e]}};c(t),null==s||s(t)};return(null==t?void 0:t.webflowAccessToken)?m?(0,r.jsx)("div",{children:"Loading sites..."}):(0,r.jsx)("div",{className:"card bg-base-100 shadow-xl",children:(0,r.jsxs)("div",{className:"card-body",children:[(0,r.jsx)("h2",{className:"card-title",children:"Webflow Settings"}),(0,r.jsx)("p",{className:"text-sm opacity-70 mb-3",children:"Select the Webflow site where you want to sync your Printful products."}),(0,r.jsx)(h,{sites:(null==d?void 0:d.result)||[],selectedSiteId:l.siteId,onSiteSelect:e=>{let t={...l,siteId:e};c(t),null==s||s(t),o.invalidateQueries({queryKey:["orders"]}),o.invalidateQueries({queryKey:["order-details"]})}}),l.siteId&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"divider",children:"Sync Options"}),(0,r.jsx)("div",{className:"form-control",children:(0,r.jsxs)("label",{className:"label cursor-pointer justify-start gap-4",children:[(0,r.jsx)("input",{type:"checkbox",className:"checkbox checkbox-primary",checked:l.syncOptions.autoDraft,onChange:()=>p("autoDraft")}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"label-text font-medium",children:"Auto Draft"}),(0,r.jsx)("p",{className:"text-xs opacity-70",children:"Create products as drafts instead of publishing immediately"})]})]})}),(0,r.jsx)("div",{className:"form-control",children:(0,r.jsxs)("label",{className:"label cursor-pointer justify-start gap-4",children:[(0,r.jsx)("input",{type:"checkbox",className:"checkbox checkbox-primary",checked:l.syncOptions.includeImages,onChange:()=>p("includeImages")}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"label-text font-medium",children:"Include Images"}),(0,r.jsx)("p",{className:"text-xs opacity-70",children:"Sync product images from Printful"})]})]})}),(0,r.jsx)("div",{className:"form-control",children:(0,r.jsxs)("label",{className:"label cursor-pointer justify-start gap-4",children:[(0,r.jsx)("input",{type:"checkbox",className:"checkbox checkbox-primary",checked:l.syncOptions.skipExisting,onChange:()=>p("skipExisting")}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"label-text font-medium",children:"Skip Existing"}),(0,r.jsx)("p",{className:"text-xs opacity-70",children:"Skip products that already exist in Webflow"})]})]})})]})]})}):(0,r.jsxs)("div",{className:"alert alert-warning",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,r.jsx)("span",{children:"Please connect your Webflow account first"})]})}},2118:(e,s,t)=>{"use strict";t.d(s,{z:()=>i});var r=t(2115);let a="webflowSettings",n={siteId:"",syncOptions:{autoDraft:!0,includeImages:!0,skipExisting:!1}};function i(){let[e,s]=(0,r.useState)(n);return(0,r.useEffect)(()=>{let e=localStorage.getItem(a);if(e)try{let t=JSON.parse(e);s(t)}catch(e){console.error("Failed to parse saved WebflowSettings:",e)}},[]),{settings:e,updateSettings:e=>{s(e),localStorage.setItem(a,JSON.stringify(e))}}}},5111:e=>{"use strict";e.exports={reactStrictMode:!0,basePath:"/cosmic",images:{remotePatterns:[{protocol:"https",hostname:"files.cdn.printful.com"}]}}},5427:(e,s,t)=>{Promise.resolve().then(t.bind(t,978))}},e=>{var s=s=>e(e.s=s);e.O(0,[108,25,260,441,684,358],()=>s(5427)),_N_E=e.O()}]);