"use strict";(()=>{var e={};e.id=596,e.ids=[596],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},11997:e=>{e.exports=require("punycode")},12412:e=>{e.exports=require("assert")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64346:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>g,routeModule:()=>c,serverHooks:()=>m,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>x});var s={};t.r(s),t.d(s,{POST:()=>l});var o=t(96559),i=t(48088),n=t(37719),u=t(32190),d=t(19854),a=t(44678),p=t(22563);async function l(e){let r=await (0,d.getServerSession)(a.N);if(!r?.webflowAccessToken||!r?.printfulAccessToken)return u.NextResponse.json({error:"Authentication required for both Webflow and Printful"},{status:401});try{let{siteId:t}=await e.json();if(!t)return u.NextResponse.json({error:"Site ID is required"},{status:400});let s=new p.WebflowClient({accessToken:r.webflowAccessToken}),o=await s.orders.list(t,{limit:100}),i=o?.orders?.filter(e=>!e.fulfilledOn&&"refunded"!==e.status&&"disputed"!==e.status)??[];if(i?.length===0)return u.NextResponse.json({message:"No unfulfilled orders found",success:!0,count:0});let n=await Promise.all(i.map(async e=>{try{let o={external_id:e.orderId,shipping:"STANDARD",recipient:{name:e.customerInfo?.fullName||"",email:e.customerInfo?.email||"",address1:e.shippingAddress?.line1||"",address2:e.shippingAddress?.line2||"",city:e.shippingAddress?.city||"",state_code:e.shippingAddress?.state||"",country_code:e.shippingAddress?.country||"",zip:e.shippingAddress?.postalCode||"",phone:""},items:e.purchasedItems?.map(r=>{if(!r.variantSku){if(console.log(`Missing SKU for item in order ${e.orderId}:`,r),r.productId)return{product_id:r.productId,quantity:r.count};throw Error(`Item is missing both SKU and product ID in order ${e.orderId}`)}let t=r.variantSku.match(/PF-(\d+)/);return t&&t[1]?{variant_id:parseInt(t[1]),quantity:r.count}:{sku:r?.variantSku,quantity:r.count}})},i=await fetch("https://api.printful.com/orders",{method:"POST",headers:{Authorization:`Bearer ${r.printfulAccessToken}`,"Content-Type":"application/json"},body:JSON.stringify(o)}),n=await i.json();if(!i.ok)throw Error(n.error?.message||"Failed to create Printful order");if(!e.orderId)throw Error("Order ID is missing");return await s.orders.updateFulfill(t,e.orderId,{sendOrderFulfilledEmail:!1}),{orderId:e.orderId,success:!0,printfulOrderId:n.result.id}}catch(r){return console.error(`Error processing order ${e.orderId}:`,r),{orderId:e.orderId,success:!1,error:r instanceof Error?r.message:String(r)}}})),d=n.filter(e=>e.success).length,a=n.filter(e=>!e.success).length;return u.NextResponse.json({success:!0,message:`Successfully processed ${d} orders. Failed: ${a} orders.`,results:n,totalProcessed:n.length})}catch(e){return console.error("Error in bulk order fulfillment:",e),u.NextResponse.json({error:"Failed to process orders",details:e instanceof Error?e.message:String(e)},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/webflow/orders/fulfill-bulk/route",pathname:"/api/webflow/orders/fulfill-bulk",filename:"route",bundlePath:"app/api/webflow/orders/fulfill-bulk/route"},resolvedPagePath:"/Users/vicplummer/printful-app-test/src/app/api/webflow/orders/fulfill-bulk/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:x,serverHooks:m}=c;function g(){return(0,n.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:x})}},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[243,580,37,563,762],()=>t(64346));module.exports=s})();