"use strict";(()=>{var e={};e.id=390,e.ids=[390],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10637:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>w,serverHooks:()=>v,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{POST:()=>g});var a=r(96559),i=r(48088),s=r(37719),n=r(32190),l=r(19854),u=r(44678),c=r(22563),d=r(88328);async function p(e,t,r){let o=r.toString();console.log(`ðŸ” Searching for variant_id: ${o}`);let a=await e.products.list(t);for(let e of(console.log(`Found ${a.items?.length||0} total products to check`),a.items||[])){if(e.sku?.fieldData.sku&&console.log(`Checking main SKU: ${e.sku.fieldData.sku} (${typeof e.sku.fieldData.sku}) against ${o} (${typeof o})`),e.sku?.fieldData.sku===o)return console.log("âœ… Found match in main SKU!"),{productId:e.id,skuId:e.sku.id};for(let t of(e.skus?.length&&console.log(`Checking ${e.skus.length} additional SKUs for product ${e}`),e.skus||[]))if(t.fieldData.sku&&console.log(`Checking SKU: ${t.fieldData.sku} (${typeof t.fieldData.sku}) against ${o} (${typeof o})`),t.fieldData.sku===o)return console.log("âœ… Found match in additional SKUs!"),{productId:e.id,skuId:t.id}}return console.log("âŒ No matching SKU found"),null}function f(e){return{color:(e.color||"Default").toLowerCase().replace(/[^a-z0-9]+/g,"-"),size:(e.size||"One Size").toLowerCase().replace(/[^a-z0-9]+/g,"-")}}async function g(e){try{let t=await (0,l.getServerSession)(u.N);if(!t?.webflowAccessToken||!t?.printfulAccessToken)return n.NextResponse.json({error:"Authentication required"},{status:401});let{productId:r,siteId:o}=await e.json();if(!r||!o)return n.NextResponse.json({error:"Product ID and Site ID are required"},{status:400});let a=await (0,d.aW)(r,t.printfulAccessToken);if(!a||!a.sync_variants)throw Error("Invalid product details response");let i=await Promise.all(a.sync_variants.map(async e=>{try{let o=await (0,d.Gj)(e.id.toString(),t.printfulAccessToken);return{id:e.id.toString(),name:o.name,variant_id:e.id.toString(),product_id:r,retail_price:o.retail_price||"0.00",sku:e.id.toString(),color:e.color,size:e.size,thumbnail_url:o.files?.find(e=>"preview"===e.type)?.preview_url||o.product.image||"",preview_url:o.files?.find(e=>"preview"===e.type)?.preview_url||null}}catch(t){return console.error(`Error fetching variant details for ${e.id}:`,t),{id:e.id.toString(),name:e.name,variant_id:e.variant_id.toString(),product_id:r,retail_price:e.retail_price||"0.00",sku:e.id.toString(),thumbnail_url:"",preview_url:null,color:e.color,size:e.size}}})),s={id:r,name:a.sync_product.name,thumbnail_url:a.thumbnail_url||"",variants:i};console.log("Printful Product:",s),console.log("\n=== Starting Sync Check ==="),console.log("Product:",s.name),console.log("Variants to check:",s.variants.map(e=>e.variant_id));let g=new c.WebflowClient({accessToken:t.webflowAccessToken}),w=await p(g,o,s.variants[0].variant_id);if(console.log("\n\uD83D\uDD0D Sync Check Results:"),console.log("Existing product found:",w?"YES":"NO"),w&&(console.log("Product ID:",w.productId),console.log("SKU ID:",w.skuId)),console.log("\nâ³ Waiting 5 seconds before proceeding..."),await new Promise(e=>setTimeout(e,5e3)),console.log("Proceeding with operation..."),w){let e=[];for(let t of s.variants)await p(g,o,t.variant_id)||(console.log(`Adding variant ${t.variant_id} to skusToAdd`),e.push({fieldData:{name:`${s.name} - ${t.name}`,slug:`${s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}-${t.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}`,sku:t.variant_id.toString(),"sku-values":{color:t.variant_properties?.find(e=>"color"===e.type)?.value||"",size:t.variant_properties?.find(e=>"size"===e.type)?.value||""},price:{value:Math.round(100*parseFloat(t.retail_price)),unit:"USD"},"main-image":t.thumbnail_url||s.thumbnail_url}}));if(e.length>0){console.log(`Attempting to add ${e.length} SKUs...`);let r=await fetch(`https://api.webflow.com/v2/sites/${o}/products/${w.productId}/skus`,{method:"POST",headers:{Authorization:`Bearer ${t.webflowAccessToken}`,"Content-Type":"application/json"},body:JSON.stringify({publishStatus:"live",skus:e})});if(!r.ok){let e=await r.text();throw console.error("Failed to add SKUs:",e),Error(`Failed to add SKUs: ${e}`)}let a=await r.json();console.log("SKUs creation response:",a)}return n.NextResponse.json({message:"Product updated successfully",productId:w.productId,skusAdded:e.length})}let h={publishStatus:"live",product:{fieldData:{name:s.name,slug:s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),"sku-properties":function(e){let t=new Map;return t.set("Color",new Set),t.set("Size",new Set),e.forEach(e=>{console.log("Variant:",e),t.get("Color")?.add(e.color||"Default"),t.get("Size")?.add(e.size||"One Size")}),Array.from(t.entries()).map(([e,t])=>({id:e.toLowerCase().replace(/[^a-z0-9]+/g,"-"),name:e,enum:Array.from(t).map(e=>({id:e.toLowerCase().replace(/[^a-z0-9]+/g,"-"),name:e,slug:e.toLowerCase().replace(/[^a-z0-9]+/g,"-")}))}))}(s.variants),lastsynced:new Date().toISOString()}},sku:{fieldData:{name:`${s.name} - ${s.variants[0].color} / ${s.variants[0].size}`,slug:`${s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}-${s.variants[0].variant_id}`,sku:s.variants[0].id.toString(),price:{value:Math.round(100*parseFloat(s.variants[0].retail_price)),unit:"USD"},"sku-values":f(s.variants[0]),"main-image":s.variants[0].preview_url||s.variants[0].thumbnail_url,"sync-variant-id":"TEST"}}},m=await g.products.create(o,h);if(s.variants.length>1&&m.product?.id){console.log(`Creating ${s.variants.length-1} additional SKUs for new product...`);let e=s.variants.slice(1).map(e=>({fieldData:{name:`${s.name} - ${e.color} / ${e.size}`,slug:`${s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}-${e.variant_id}`,sku:e.id.toString(),price:{value:Math.round(100*parseFloat(e.retail_price)),unit:"USD"},"sku-values":f(e),"main-image":e.preview_url||e.thumbnail_url}})),r=await fetch(`https://api.webflow.com/v2/sites/${o}/products/${m.product.id}/skus`,{method:"POST",headers:{Authorization:`Bearer ${t.webflowAccessToken}`,"Content-Type":"application/json"},body:JSON.stringify({publishStatus:"live",skus:e})});if(!r.ok){let e=await r.text();throw console.error("Failed to add SKUs to new product:",e),Error(`Failed to add SKUs to new product: ${e}`)}let a=await r.json();console.log("SKUs creation response for new product:",a)}return n.NextResponse.json({message:"Product created successfully",productId:m.product?.id,variantsAdded:s.variants.length-1})}catch(e){return console.error("Error in sync process:",e),n.NextResponse.json({error:"Failed to sync product"},{status:500})}}let w=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/webflow/sync/route",pathname:"/api/webflow/sync",filename:"route",bundlePath:"app/api/webflow/sync/route"},resolvedPagePath:"/Users/vicplummer/printful-app-test/src/app/api/webflow/sync/route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:h,workUnitAsyncStorage:m,serverHooks:v}=w;function k(){return(0,s.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:m})}},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},11997:e=>{e.exports=require("punycode")},12412:e=>{e.exports=require("assert")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},88328:(e,t,r)=>{async function o(e){let t=await fetch("https://api.printful.com/store/products",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error(`Failed to fetch Printful products: ${t.statusText}`);return(await t.json()).result||[]}async function a(e,t){let r=await fetch(`https://api.printful.com/store/products/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw Error(`Failed to fetch Printful product: ${r.statusText}`);return(await r.json()).result}async function i(e,t){let r=await fetch(`https://api.printful.com/store/variants/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw Error(`Failed to fetch variant details: ${r.statusText}`);return(await r.json()).result}r.d(t,{Gj:()=>i,aW:()=>a,f5:()=>o})},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[243,580,37,563,762],()=>r(10637));module.exports=o})();