"use strict";(()=>{var e={};e.id=577,e.ids=[577],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},11997:e=>{e.exports=require("punycode")},12412:e=>{e.exports=require("assert")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{e.exports=require("tls")},37366:e=>{e.exports=require("dns")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{e.exports=require("zlib")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},81630:e=>{e.exports=require("http")},83997:e=>{e.exports=require("tty")},88328:(e,t,r)=>{async function s(e){let t=await fetch("https://api.printful.com/store/products",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error(`Failed to fetch Printful products: ${t.statusText}`);return(await t.json()).result||[]}async function i(e,t){let r=await fetch(`https://api.printful.com/store/products/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw Error(`Failed to fetch Printful product: ${r.statusText}`);return(await r.json()).result}async function n(e,t){let r=await fetch(`https://api.printful.com/store/variants/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw Error(`Failed to fetch variant details: ${r.statusText}`);return(await r.json()).result}r.d(t,{Gj:()=>n,aW:()=>i,f5:()=>s})},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},98939:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>h,serverHooks:()=>w,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>f});var i=r(96559),n=r(48088),a=r(37719),o=r(19854),u=r(44678),l=r(32190),p=r(22563),c=r(16886),d=r(88328);async function f(e){let t=await (0,o.getServerSession)(u.N);if(!t)return l.NextResponse.json({error:"Authentication required"},{status:401});if(!t.printfulAccessToken){let e=await (0,c.X)("printful");if(!e)return l.NextResponse.json({error:"Authentication required"},{status:401});t.printfulAccessToken=e}let{searchParams:r}=new URL(e.url),s=r.get("siteId");if(!s)return l.NextResponse.json({error:"Webflow site ID is required"},{status:400});let i=t.printfulAccessToken;try{console.log("Fetching Printful products with token:",i.substring(0,10)+"...");let e=await (0,d.f5)(i);if(!Array.isArray(e)||0===e.length)return console.log("No products found in Printful store"),l.NextResponse.json({result:[]});console.log(`Found ${e.length} products, fetching details...`);let r=await Promise.all(e.map(async e=>{try{let t=await (0,d.aW)(e.id.toString(),i);if(!t||!t.sync_variants)throw Error("Invalid product details response");let r=await Promise.all(t.sync_variants.map(async t=>{try{let r=await (0,d.Gj)(t.id.toString(),i);return{id:t.id.toString(),name:r.name,variant_id:t.id.toString(),product_id:e.id.toString(),retail_price:r.retail_price||"0.00",sku:t.id.toString(),thumbnail_url:r.files?.find(e=>"preview"===e.type)?.preview_url||r.product.image||"",preview_url:r.files?.find(e=>"preview"===e.type)?.preview_url||null,availability_status:r.availability_status,sync_status:"not_synced",lastSynced:null}}catch(i){var r,s;return console.error(`Error fetching variant details for ${t.id}:`,i),r=t,s=e.id,{id:r.id.toString(),name:r.name,variant_id:r.variant_id.toString(),product_id:s.toString(),retail_price:r.retail_price||"0.00",sku:r.sku||`PF-${r.variant_id}`,thumbnail_url:"",preview_url:null,availability_status:"unknown",sync_status:"not_synced",lastSynced:null}}}));return{id:e.id.toString(),name:e.name,thumbnail_url:e.thumbnail_url||"",variants:r}}catch(r){var t;return console.error(`Error processing product ${e.id}:`,r),{id:(t=e).id.toString(),name:t.name,thumbnail_url:t.thumbnail_url||"",variants:[],sync_status:"not_synced"}}})),n=new Map;if(t.webflowAccessToken&&s)try{let e=new p.WebflowClient({accessToken:t.webflowAccessToken}),r=await e.products.list(s);r.items?.forEach(e=>{let t=e.product?.fieldData;t?.sku&&n.set(t.sku,{lastSynced:t.lastSynced}),e.skus?.forEach(e=>{let t=e.fieldData;t?.sku&&n.set(t.sku,{lastSynced:t.lastSynced})})})}catch(e){console.error("Error fetching Webflow products:",e)}let a=r.map(e=>({...e,variants:e.variants.map(e=>{let t=n.get(e.sku);return{...e,sync_status:t?"synced":"not_synced",lastSynced:t?.lastSynced||null}})}));return l.NextResponse.json({result:a})}catch(e){return console.error("Error fetching Printful products:",e),l.NextResponse.json({error:"Failed to fetch Printful products"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/printful/store/products/route",pathname:"/api/printful/store/products",filename:"route",bundlePath:"app/api/printful/store/products/route"},resolvedPagePath:"/Users/vicplummer/printful-app-test/src/app/api/printful/store/products/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:x,serverHooks:w}=h;function v(){return(0,a.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:x})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[243,580,37,563,762],()=>r(98939));module.exports=s})();